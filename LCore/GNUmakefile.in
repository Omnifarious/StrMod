CXX = g++ -m486 -pipe
CPPFLAGS = -I/home/hopper/src/include++ -DBYTE_ORDER_DEFINED -DORDER_XINU -pipe -O2

%.o : %.cxx
	$(CXX) -c $(@:.o=.cxx) $(CPPFLAGS) $(CXXFLAGS) -o $@

%.s.o : %.cxx
	$(CXX) -c $(@:.s.o=.cxx) $(CPPFLAGS) $(CXXFLAGS) -fPIC -o $@

%.cxx.d : %.cxx
	+$(CXX) -c $< $(CPPFLAGS) $(CXXFLAGS) -MM | sed "s;$<;;" | sed 's;^$(notdir $*)\.o;$*.cxx;' | dependdb update --addtouch $< $<

MYMAKE := $(MAKE)

LIBCCS = classimp.cxx  defproto.cxx  hopclimp.cxx  objctstr.cxx \
         progrimp.cxx  clsprgid.cxx  cltpsstr.cxx  gentyimp.cxx \
         objctstd.cxx  objecimp.cxx  protoimp.cxx  defeh_cl.cxx \
         defspscl.cxx  defrefco.cxx  refcoimp.cxx  rfcntptr.cxx \
         rfcntptt.cxx  debugabl.cxx

TESTCCS = tests/refcnt.cxx

CCNAMES = $(LIBCCS) $(TESTCCS)

SONAMES = $(CCNAMES:.cxx=.s.o)

/home/hopper/lib/libLCore.a : $(CCNAMES)
	$(MAKE) $(?:.cxx=.o)
	ar rv $@ $(?:.cxx=.o)
	rm -f $(?:.cxx=.o)

$(EXTLIBTAG) : $(CCNAMES)
	$(MAKE) $(?:.cxx=.o)
	touch $(EXTLIBTAG)
	ar rv $(EXTLIB) $(?:.cxx=.o)
	rm -f $(?:.cxx=.o)

tests/refcnt : tests/refcnt.o rfcntptt.o rfcntptr.o refcoimp.o protoimp.o \
               hopclimp.o classimp.o defrefco.o defproto.o clsprgid.o \
               defeh_cl.o cltpsstr.o objctstr.o objecimp.o objctstd.o
	$(CXX) $^ $(LDFLAGS) $(LIBS) -o tests/refcnt

GNUmakefile : depend.stamp
	dependdb list --makefiles GNUmakefile GNUmakefile.new
	mv GNUmakefile GNUmakefile~
	mv GNUmakefile.new GNUmakefile

depend.stamp : $(CCNAMES)
	rm -f GNUmakefile.old
	ln GNUmakefile GNUmakefile.old
	$(MYMAKE) -f GNUmakefile.old $(?:.cxx=.cc.d)
	rm -f GNUmakefile.old
	touch depend.stamp

##Do not delete this line, or the line after...
##Heh, heh, heh.

